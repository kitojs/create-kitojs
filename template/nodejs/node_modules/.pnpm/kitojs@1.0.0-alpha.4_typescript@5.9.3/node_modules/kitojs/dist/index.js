import{ServerCore as e,getAllCookies as t,getAllHeaders as n,getAllParams as r,getAllQuery as i,getBodyBuffer as a,getCookie as o,getHeader as s,getHostname as c,getIp as l,getIps as u,getMethod as d,getParam as f,getPathname as p,getProtocol as m,getQueryParam as h,getSearch as g,getSecure as _,getUrl as v,getXhr as y,sendResponse as b}from"@kitojs/kito-core";import{readFileSync as x}from"node:fs";import*as S from"acorn";import*as C from"acorn-walk";var w=class{_type;_optional=!1;_default=void 0;constraints=[];min(e){return this.constraints.push({type:`min`,value:e}),this}max(e){return this.constraints.push({type:`max`,value:e}),this}length(e){return this.constraints.push({type:`length`,value:e}),this}email(){return this.constraints.push({type:`email`}),this}url(){return this.constraints.push({type:`url`}),this}uuid(){return this.constraints.push({type:`uuid`}),this}regex(e){return this.constraints.push({type:`regex`,value:e}),this}optional(){let e=Object.assign(Object.create(Object.getPrototypeOf(this)),this);return e._optional=!0,e}default(e){let t=Object.assign(Object.create(Object.getPrototypeOf(this)),this);return t._optional=!0,t._default=e,t}_serialize(){return{type:`string`,optional:this._optional,default:this._default,constraints:this.constraints}}},T=class{_type;_optional=!1;_default=void 0;constraints=[];min(e){return this.constraints.push({type:`min`,value:e}),this}max(e){return this.constraints.push({type:`max`,value:e}),this}int(){return this.constraints.push({type:`int`}),this}positive(){return this.constraints.push({type:`positive`}),this}negative(){return this.constraints.push({type:`negative`}),this}optional(){let e=Object.assign(Object.create(Object.getPrototypeOf(this)),this);return e._optional=!0,e}default(e){let t=Object.assign(Object.create(Object.getPrototypeOf(this)),this);return t._optional=!0,t._default=e,t}_serialize(){return{type:`number`,optional:this._optional,default:this._default,constraints:this.constraints}}},E=class{_type;_optional=!1;_default=void 0;optional(){let e=Object.assign(Object.create(Object.getPrototypeOf(this)),this);return e._optional=!0,e}default(e){let t=Object.assign(Object.create(Object.getPrototypeOf(this)),this);return t._optional=!0,t._default=e,t}_serialize(){return{type:`boolean`,optional:this._optional,default:this._default}}},D=class{_type;_optional=!1;_default=void 0;constraints=[];constructor(e){this.item=e}min(e){return this.constraints.push({type:`min`,value:e}),this}max(e){return this.constraints.push({type:`max`,value:e}),this}length(e){return this.constraints.push({type:`length`,value:e}),this}optional(){let e=Object.assign(Object.create(Object.getPrototypeOf(this)),this);return e._optional=!0,e}default(e){let t=Object.assign(Object.create(Object.getPrototypeOf(this)),this);return t._optional=!0,t._default=e,t}_serialize(){return{type:`array`,optional:this._optional,default:this._default,constraints:this.constraints,item:this.item._serialize()}}},O=class{_type;_optional=!1;_default=void 0;shape;constructor(e){this.shape=e}optional(){let e=Object.assign(Object.create(Object.getPrototypeOf(this)),this);return e._optional=!0,e}default(e){let t=Object.assign(Object.create(Object.getPrototypeOf(this)),this);return t._optional=!0,t._default=e,t}_serialize(){let e={};for(let[t,n]of Object.entries(this.shape))e[t]=n._serialize();return{type:`object`,optional:this._optional,default:this._default,shape:e}}},k=class{_type;_optional=!1;_default=void 0;constructor(e){this.value=e}optional(){let e=Object.assign(Object.create(Object.getPrototypeOf(this)),this);return e._optional=!0,e}default(e){let t=Object.assign(Object.create(Object.getPrototypeOf(this)),this);return t._optional=!0,t._default=e,t}_serialize(){return{type:`literal`,optional:this._optional,default:this._default,value:this.value}}},A=class{_type;_optional=!1;_default=void 0;constructor(e){this.schemas=e}optional(){let e=Object.assign(Object.create(Object.getPrototypeOf(this)),this);return e._optional=!0,e}default(e){let t=Object.assign(Object.create(Object.getPrototypeOf(this)),this);return t._optional=!0,t._default=e,t}_serialize(){return{type:`union`,optional:this._optional,default:this._default,schemas:this.schemas.map(e=>e._serialize())}}};const j={str(){return new w},num(){return new T},bool(){return new E},array(e){return new D(e)},object(e){return new O(e)},literal(e){return new k(e)},union(...e){return new A(e)}};function M(e){return e}function N(e){return{type:`function`,handler:e,global:!1}}var P=class{core;_body;_headers;_query;_params;_cookies;_method;_url;_pathname;_search;_protocol;_hostname;_ip;_ips;_secure;_xhr;constructor(e){this.core=e}get body(){if(this._body)return this._body;let e=a(this.core);if((this.header(`content-type`)??``).includes(`application/json`))try{this._body=JSON.parse(e.toString(`utf-8`))}catch{this._body={}}else this._body=e;return this._body}json(){return JSON.parse(this.body.toString(`utf-8`))}text(){return this.body.toString(`utf-8`)}get headers(){return this._headers||=n(this.core),this._headers}header(e){return s(this.core,e.toLowerCase())??void 0}get query(){return this._query||=i(this.core),this._query}queryParam(e){let t=h(this.core,e);if(t)return t.length===1?t[0]:t}get params(){return this._params||=r(this.core),this._params}param(e){return f(this.core,e)??void 0}get cookies(){return this._cookies||=t(this.core),this._cookies}cookie(e){return o(this.core,e)??void 0}get method(){return this._method||=d(this.core),this._method}get url(){return this._url||=v(this.core),this._url}get pathname(){return this._pathname||=p(this.core),this._pathname}get search(){return this._search===void 0&&(this._search=g(this.core)??null),this._search}get protocol(){return this._protocol||=m(this.core),this._protocol}get hostname(){return this._hostname||=c(this.core),this._hostname}get ip(){return this._ip||=l(this.core),this._ip}get ips(){return this._ips||=u(this.core),this._ips}get secure(){return this._secure===void 0&&(this._secure=_(this.core)),this._secure}get xhr(){return this._xhr===void 0&&(this._xhr=y(this.core)),this._xhr}get originalUrl(){return this.url}get raw(){return{body:this.body,headers:this.headers,url:this.url,method:this.method}}};const F={100:`Continue`,101:`Switching Protocols`,200:`OK`,201:`Created`,202:`Accepted`,204:`No Content`,301:`Moved Permanently`,302:`Found`,304:`Not Modified`,400:`Bad Request`,401:`Unauthorized`,403:`Forbidden`,404:`Not Found`,405:`Method Not Allowed`,500:`Internal Server Error`,502:`Bad Gateway`,503:`Service Unavailable`};var I=class{channel;state;finished=!1;constructor(e){this.channel=e,this.state={status:200,headers:new Map}}checkFinished(){if(this.finished)throw Error(`Response already sent`)}serializeAndSend(){let e=Array.from(this.state.headers.entries()),t=JSON.stringify(e),n=Buffer.from(t,`utf-8`),r=this.state.body||Buffer.alloc(0),i=6+n.length+r.length,a=Buffer.allocUnsafe(i),o=0;a.writeUInt16LE(this.state.status,o),o+=2,a.writeUInt32LE(n.length,o),o+=4,n.copy(a,o),o+=n.length,r.length>0&&r.copy(a,o),b(this.channel,a),this.finished=!0}status(e){return this.checkFinished(),this.state.status=e,this}sendStatus(e){this.checkFinished();let t=F[e]||`Unknown`;this.state.status=e,this.state.body=Buffer.from(t,`utf-8`),this.serializeAndSend()}header(e,t){return this.checkFinished(),this.state.headers.set(e.toLowerCase(),t),this}headers(e){this.checkFinished();for(let[t,n]of Object.entries(e))this.state.headers.set(t.toLowerCase(),n);return this}append(e,t){this.checkFinished();let n=e.toLowerCase(),r=this.state.headers.get(n);return r?this.state.headers.set(n,`${r}, ${t}`):this.state.headers.set(n,t),this}set(e,t){return this.header(e,t)}get(e){return this.state.headers.get(e.toLowerCase())}type(e){return this.checkFinished(),e.includes(`/`)||(e={html:`text/html`,json:`application/json`,xml:`application/xml`,text:`text/plain`,txt:`text/plain`,js:`application/javascript`,css:`text/css`,png:`image/png`,jpg:`image/jpeg`,jpeg:`image/jpeg`,gif:`image/gif`,svg:`image/svg+xml`,pdf:`application/pdf`,zip:`application/zip`}[e]||e),this.header(`content-type`,e)}contentType(e){return this.type(e)}cookie(e,t,n){this.checkFinished();let r=this.serializeCookie(e,t,n),i=this.state.headers.get(`set-cookie`);return i?this.state.headers.set(`set-cookie`,`${i}, ${r}`):this.state.headers.set(`set-cookie`,r),this}serializeCookie(e,t,n){let r=`${e}=${t}`;if(n?.maxAge!==void 0&&(r+=`; Max-Age=${n.maxAge}`),n?.path?r+=`; Path=${n.path}`:r+=`; Path=/`,n?.domain&&(r+=`; Domain=${n.domain}`),n?.httpOnly&&(r+=`; HttpOnly`),n?.secure&&(r+=`; Secure`),n?.sameSite){let e=typeof n.sameSite==`string`?n.sameSite:n.sameSite?`Strict`:`Lax`;r+=`; SameSite=${e}`}return r}clearCookie(e,t){this.checkFinished();let n={...t,maxAge:0,expires:new Date(0)};return this.cookie(e,``,n)}send(e){this.checkFinished(),Buffer.isBuffer(e)?this.state.body=e:typeof e==`string`?this.state.body=Buffer.from(e,`utf-8`):this.state.body=Buffer.from(String(e),`utf-8`),this.serializeAndSend()}json(e){this.checkFinished(),this.type(`application/json`);let t=JSON.stringify(e);this.state.body=Buffer.from(t,`utf-8`),this.serializeAndSend()}text(e){this.checkFinished(),this.type(`text/plain`),this.state.body=Buffer.from(e,`utf-8`),this.serializeAndSend()}html(e){this.checkFinished(),this.type(`text/html`),this.state.body=Buffer.from(e,`utf-8`),this.serializeAndSend()}redirect(e,t){this.checkFinished(),this.state.status=t||302,this.header(`location`,e),this.serializeAndSend()}location(e){return this.checkFinished(),this.header(`location`,e)}attachment(e){if(this.checkFinished(),e){let t=encodeURIComponent(e);return this.header(`content-disposition`,`attachment; filename="${t}"`)}return this.header(`content-disposition`,`attachment`)}download(e,t){this.checkFinished();let n=t||e.split(`/`).pop()||`download`;this.attachment(n);try{this.state.body=x(e),this.serializeAndSend()}catch{this.state.status=404,this.state.body=Buffer.from(`File Not Found`,`utf-8`),this.serializeAndSend()}}sendFile(e,t){this.checkFinished();try{let n=t?.root?`${t.root}/${e}`:e;this.state.body=x(n);let r=this.getMimeType(e);this.type(r),t?.headers&&this.headers(t.headers),this.serializeAndSend()}catch{this.state.status=404,this.state.body=Buffer.from(`File Not Found`,`utf-8`),this.serializeAndSend()}}getMimeType(e){return{html:`text/html`,htm:`text/html`,css:`text/css`,js:`application/javascript`,mjs:`application/javascript`,json:`application/json`,xml:`application/xml`,txt:`text/plain`,png:`image/png`,jpg:`image/jpeg`,jpeg:`image/jpeg`,gif:`image/gif`,svg:`image/svg+xml`,webp:`image/webp`,ico:`image/x-icon`,pdf:`application/pdf`,zip:`application/zip`,wasm:`application/wasm`,mp4:`video/mp4`,webm:`video/webm`,mp3:`audio/mpeg`,wav:`audio/wav`,woff:`font/woff2`,woff2:`font/woff2`,ttf:`font/ttf`,otf:`font/otf`}[e.split(`.`).pop()?.toLowerCase()||``]||`application/octet-stream`}vary(e){return this.checkFinished(),this.append(`vary`,e)}links(e){this.checkFinished();let t=Object.entries(e).map(([e,t])=>`<${t}>; rel="${e}"`).join(`, `);return this.header(`link`,t)}format(e){this.checkFinished();let t=this.get(`accept`)||`*/*`;for(let[n,r]of Object.entries(e))if(t.includes(n)||t.includes(`*/*`))return r(),this;let n=Object.values(e)[0];return n&&n(),this}};function L(e){let t=e.toString();try{let e=S.parse(t,{ecmaVersion:2022,sourceType:`module`}),n=null,r=!1,i=new Set,a=new Set;if(C.simple(e,{CallExpression(e){if(e.callee.type===`MemberExpression`&&e.callee.object.type===`MemberExpression`&&e.callee.object.property.name===`res`){let t=e.callee.property.name;if([`send`,`json`,`text`,`html`].includes(t)){if(n!==null){r=!0;return}let i={method:t,arg:e.arguments[0],usesContext:!1};C.simple(e.arguments[0],{MemberExpression(e){e.object.type===`Identifier`&&e.object.name===`ctx`&&(i.usesContext=!0)}}),n=i}}},MemberExpression(e){e.object.type===`MemberExpression`&&e.object.object.type===`MemberExpression`&&e.object.object.property.name===`req`&&e.object.property.name===`params`&&e.property.type===`Identifier`&&i.add(e.property.name),e.object.type===`MemberExpression`&&e.object.object.type===`MemberExpression`&&e.object.object.property.name===`req`&&e.object.property.name===`query`&&e.property.type===`Identifier`&&a.add(e.property.name)},VariableDeclaration(){r=!0},IfStatement(){r=!0},ForStatement(){r=!0},WhileStatement(){r=!0}}),!n)return{type:`none`};let o=n;if(r)return{type:`none`};if(!o.usesContext){let e=R(o.arg,t);if(e===null)return{type:`none`};let{body:n,contentType:r}=z(o.method,e);return{type:`full_static`,method:o.method,status:200,headers:{"content-type":r,"content-length":n.length.toString()},body:n.toString(`base64`)}}if((i.size>0||a.size>0)&&o.method===`json`&&o.arg?.type===`ObjectExpression`){let e=B(o.arg);return{type:`param_template`,method:`json`,status:200,headers:{"content-type":`application/json`},template:e,params:Array.from(i)}}return{type:`none`}}catch(e){return console.warn(`Failed to analyze handler:`,e),{type:`none`}}}function R(e,t){if(!e)return null;try{switch(e.type){case`Literal`:return e.value;case`ObjectExpression`:let n={};for(let r of e.properties)if(r.type===`Property`&&r.key.type===`Identifier`){let e=R(r.value,t);if(e===null)return null;n[r.key.name]=e}return n;case`ArrayExpression`:let r=[];for(let n of e.elements){let e=R(n,t);if(e===null)return null;r.push(e)}return r;case`TemplateLiteral`:return e.expressions.length===0?e.quasis[0].value.cooked:null;default:return null}}catch{return null}}function z(e,t){switch(e){case`json`:return{body:Buffer.from(JSON.stringify(t),`utf-8`),contentType:`application/json`};case`text`:case`send`:return{body:Buffer.from(String(t),`utf-8`),contentType:`text/plain`};case`html`:return{body:Buffer.from(String(t),`utf-8`),contentType:`text/html`};default:return{body:Buffer.from(String(t),`utf-8`),contentType:`text/plain`}}}function B(e){function t(e){return e.type===`Literal`?JSON.stringify(e.value):e.type===`MemberExpression`&&e.object.type===`MemberExpression`&&e.object.object.type===`MemberExpression`&&e.object.object.property.name===`req`?`"{{${e.object.property.name}.${e.property.name}}}"`:`null`}return`{${e.properties.map(e=>`"${e.key.name}":${t(e.value)}`).join(`,`)}}`}var V=class t{globalMiddlewares=[];serverOptions={};coreServer;extensionFn;constructor(t){this.serverOptions={...this.serverOptions,...t},this.coreServer=new e({port:3e3,host:`0.0.0.0`,...t})}extend(e){let n=new t(this.serverOptions);n.globalMiddlewares=[...this.globalMiddlewares],n.coreServer=this.coreServer;let r=this.extensionFn;return n.extensionFn=t=>{r&&r(t);let n=e(t);n&&typeof n==`object`&&Object.assign(t,n)},n}use(e){return typeof e==`function`?this.globalMiddlewares.push({type:`function`,handler:e,global:!0}):this.globalMiddlewares.push({...e,global:!0}),this}get(e,t,n){return this.addRoute(`GET`,e,t,n),this}post(e,t,n){return this.addRoute(`POST`,e,t,n),this}put(e,t,n){return this.addRoute(`PUT`,e,t,n),this}delete(e,t,n){return this.addRoute(`DELETE`,e,t,n),this}patch(e,t,n){return this.addRoute(`PATCH`,e,t,n),this}head(e,t,n){return this.addRoute(`HEAD`,e,t,n),this}options(e,t,n){return this.addRoute(`OPTIONS`,e,t,n),this}route(e){let t=this,n={get(r,i){return t.addRoute(`GET`,e,r,i),n},post(r,i){return t.addRoute(`POST`,e,r,i),n},put(r,i){return t.addRoute(`PUT`,e,r,i),n},delete(r,i){return t.addRoute(`DELETE`,e,r,i),n},patch(r,i){return t.addRoute(`PATCH`,e,r,i),n},options(r,i){return t.addRoute(`OPTIONS`,e,r,i),n},head(r,i){return t.addRoute(`HEAD`,e,r,i),n},end(){return t}};return n}addRoute(e,t,n,r){let i,a=[];typeof n==`function`?i=n:(a=n,i=r);let o=[],s;for(let e of a)this.isSchemaDefinition(e)?(s=e,o.push({type:`schema`,schema:e,global:!1})):o.push({...e,global:!1});let c={type:`none`};this.globalMiddlewares.length===0&&o.length===0&&(c=L(i));let l=this.fuseMiddlewares(this.globalMiddlewares,o,i),u=async e=>{let t={req:new P(e.req),res:new I(e.res)};this.extensionFn&&this.extensionFn(t),await l(t)},d=s?this.serializeSchema(s):void 0,f=c.type===`none`?void 0:JSON.stringify(c);this.coreServer.addRoute({method:e,path:t,handler:u,schema:d,staticResponse:f})}serializeSchema(e){let t={};return e.params&&(t.params=e.params._serialize()),e.query&&(t.query=e.query._serialize()),e.body&&(t.body=e.body._serialize()),e.headers&&(t.headers=e.headers._serialize()),JSON.stringify(t)}fuseMiddlewares(e,t,n){let r=[...e.filter(e=>e.type===`function`&&e.handler).map(e=>e.handler),...t.filter(e=>e.type===`function`&&e.handler).map(e=>e.handler)];return r.length===0?n:async e=>{let t=0,i=async()=>{if(t<r.length){let n=r[t++];return n(e,i)}else return n(e)};return i()}}isSchemaDefinition(e){return e&&(e.params||e.query||e.body||e.headers)}async listen(e,t,n){let r,i,a;typeof e==`function`?a=e:(r=e,typeof t==`function`?a=t:(i=t,a=n));let o={port:r??this.serverOptions.port??3e3,host:i??this.serverOptions.host??`0.0.0.0`,...this.serverOptions};return this.coreServer.setConfig(o),await this.coreServer.start(a),o}close(){this.coreServer.close()}};function H(e){return new V(e)}export{V as KitoServer,N as middleware,M as schema,H as server,j as t};
//# sourceMappingURL=index.js.map